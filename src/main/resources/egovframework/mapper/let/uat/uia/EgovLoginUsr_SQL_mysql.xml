<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="loginDAO">

  <!-- 로그인 처리를 위한 resultMap -->
  <resultMap id="login" type="egovframework.com.cmm.LoginVO">
    <result property="id" column="id"/>
    <result property="name" column="name"/>
    <result property="ihidNum" column="ihidNum"/>
    <result property="email" column="email"/>
    <result property="password" column="password"/>
    <result property="userSe" column="userSe"/>
    <result property="orgnztId" column="orgnztId"/>
    <result property="uniqId" column="uniqId"/>
  </resultMap>

  <!-- 일반 로그인: 서비스에서 암호화된 비밀번호와 일치 비교 -->
  <select id="actionLogin" resultMap="login">
    <!-- 일반회원 -->
    <if test="userSe == 'GNR'">
      SELECT mber_id AS id,
             mber_nm AS name,
             ihidNum AS ihidNum,
             password AS password,
             mber_email_adres AS email,
             'GNR' AS userSe,
             '-' AS orgnztId,
             esntl_id AS uniqId
        FROM LETTNGNRLMBER
       WHERE mber_id = #{id}
         AND password = #{password}
         AND mber_sttus = 'P'
       LIMIT 1
    </if>
    <!-- 기업회원 -->
    <if test="userSe == 'ENT'">
      SELECT entrprsmber_id AS id,
             cmpny_nm AS name,
             entrprs_mber_password AS password,
             bizrno AS ihidNum,
             applcnt_email_adres AS email,
             'ENT' AS userSe,
             '-' AS orgnztId,
             esntl_id AS uniqId
        FROM LETTNENTRPRSMBER
       WHERE entrprsmber_id = #{id}
         AND entrprs_mber_password = #{password}
         AND entrprs_mber_sttus = 'P'
       LIMIT 1
    </if>
    <!-- 업무사용자 -->
    <if test="userSe == 'USR'">
      SELECT emplyr_id AS id,
             user_nm AS name,
             password AS password,
             ihidnum AS ihidNum,
             email_adres AS email,
             'USR' AS userSe,
             orgnzt_id AS orgnztId,
             esntl_id AS uniqId
        FROM LETTNEMPLYRINFO
       WHERE emplyr_id = #{id}
         AND password = #{password}
         AND emplyr_sttus_code = 'P'
       LIMIT 1
    </if>
  </select>

  <!-- dev 완화 로그인: 비밀번호 비교 없이 ID + 상태만 확인 (security-dev 한정) -->
  <select id="actionLoginDevRelaxed" resultMap="login">
    <if test="userSe == 'GNR'">
      SELECT mber_id AS id, mber_nm AS name, ihidNum AS ihidNum,
             password AS password, mber_email_adres AS email,
             'GNR' AS userSe, '-' AS orgnztId, esntl_id AS uniqId
        FROM LETTNGNRLMBER
       WHERE mber_id = #{id}
         AND mber_sttus = 'P'
       LIMIT 1
    </if>
    <if test="userSe == 'ENT'">
      SELECT entrprsmber_id AS id, cmpny_nm AS name,
             entrprs_mber_password AS password, bizrno AS ihidNum,
             applcnt_email_adres AS email, 'ENT' AS userSe,
             '-' AS orgnztId, esntl_id AS uniqId
        FROM LETTNENTRPRSMBER
       WHERE entrprsmber_id = #{id}
         AND entrprs_mber_sttus = 'P'
       LIMIT 1
    </if>
    <if test="userSe == 'USR'">
      SELECT emplyr_id AS id, user_nm AS name, password AS password,
             ihidnum AS ihidNum, email_adres AS email, 'USR' AS userSe,
             orgnzt_id AS orgnztId, esntl_id AS uniqId
        FROM LETTNEMPLYRINFO
       WHERE emplyr_id = #{id}
         AND emplyr_sttus_code = 'P'
       LIMIT 1
    </if>
  </select>

  <!-- 인증서 로그인 (그대로) -->
  <select id="actionCrtfctLogin" resultMap="login">
    SELECT emplyr_id AS id,
           user_nm AS name,
           password AS password,
           ihidnum AS ihidNum,
           email_adres AS email,
           'USR' AS userSe,
           orgnzt_id AS orgnztId,
           esntl_id AS uniqId
      FROM LETTNEMPLYRINFO
     WHERE sub_dn = #{dn}
     LIMIT 1
  </select>

  <!-- 아이디 찾기 -->
  <select id="searchId" resultMap="login">
    <if test="userSe == 'GNR'">
      SELECT mber_id AS id,
             mber_nm AS name,
             mber_email_adres AS email
        FROM LETTNGNRLMBER
       WHERE mber_nm = #{name}
         AND mber_email_adres = #{email}
         AND mber_sttus = 'P'
       LIMIT 1
    </if>
    <if test="userSe == 'ENT'">
      SELECT entrprsmber_id AS id,
             cmpny_nm AS name,
             applcnt_email_adres AS email
        FROM LETTNENTRPRSMBER
       WHERE cmpny_nm = #{name}
         AND applcnt_email_adres = #{email}
         AND entrprs_mber_sttus = 'P'
       LIMIT 1
    </if>
    <if test="userSe == 'USR'">
      SELECT emplyr_id AS id,
             user_nm AS name,
             email_adres AS email
        FROM LETTNEMPLYRINFO
       WHERE user_nm = #{name}
         AND email_adres = #{email}
         AND emplyr_sttus_code = 'P'
       LIMIT 1
    </if>
  </select>

  <!-- 비밀번호 찾기 (원형 유지: 그대로 반환) -->
  <select id="searchPassword" resultMap="login">
    <if test="userSe == 'GNR'">
      SELECT password AS password
        FROM LETTNGNRLMBER
       WHERE mber_id = #{id}
         AND mber_nm = #{name}
         AND mber_email_adres = #{email}
         AND mber_sttus = 'P'
       LIMIT 1
    </if>
    <if test="userSe == 'ENT'">
      SELECT entrprs_mber_password AS password
        FROM LETTNENTRPRSMBER
       WHERE entrprsmber_id = #{id}
         AND cmpny_nm = #{name}
         AND applcnt_email_adres = #{email}
         AND entrprs_mber_sttus = 'P'
       LIMIT 1
    </if>
    <if test="userSe == 'USR'">
      SELECT password AS password
        FROM LETTNEMPLYRINFO
       WHERE emplyr_id = #{id}
         AND user_nm = #{name}
         AND email_adres = #{email}
         AND emplyr_sttus_code = 'P'
       LIMIT 1
    </if>
  </select>

  <!-- 비밀번호 변경 -->
  <update id="updatePassword">
    <if test="userSe == 'GNR'">
      UPDATE LETTNGNRLMBER
         SET password = #{password}
       WHERE mber_id = #{id}
    </if>
    <if test="userSe == 'ENT'">
      UPDATE LETTNENTRPRSMBER
         SET entrprs_mber_password = #{password}
       WHERE entrprsmber_id = #{id}
    </if>
    <if test="userSe == 'USR'">
      UPDATE LETTNEMPLYRINFO
         SET password = #{password}
       WHERE emplyr_id = #{id}
    </if>
  </update>

</mapper>
